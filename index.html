<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Glycemic Load Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">🌾 Glycemic Load Tracker</h1>

    <!-- 🔐 Auth Buttons -->
    <div class="d-flex justify-content-center mb-4">
      <button id="signInBtn" class="btn btn-success me-2">Sign in with Google</button>
      <button id="signOutBtn" class="btn btn-danger" style="display:none">Sign out</button>
    </div>

    <!-- ✅ GL Form -->
    <form id="glForm" class="row g-2" style="display:none">
      <div class="col-md-4">
        <input type="text" id="item" class="form-control" placeholder="Food item (e.g. Roti)" required>
      </div>
      <div class="col-md-3">
        <input type="number" id="quantity" class="form-control" placeholder="Quantity (g)" required>
      </div>
      <div class="col-md-3">
        <input type="number" id="glPer100g" class="form-control" placeholder="GL per 100g" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Add</button>
      </div>
    </form>

    <!-- 📋 GL List -->
    <hr class="my-4">
    <h3>Total GL: <span id="totalGL">0</span></h3>
    <ul class="list-group mt-3" id="itemList"></ul>
  </div>

  <!-- ✅ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- ✅ Your Script -->
  <script>
    // 🔧 Replace with your actual Firebase config:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM elements
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const glForm = document.getElementById("glForm");
    const itemList = document.getElementById("itemList");
    const totalGLDisplay = document.getElementById("totalGL");

    let totalGL = 0;
    let currentUserUid = null;

    // 🔐 Google Sign-In
    const provider = new firebase.auth.GoogleAuthProvider();
    signInBtn.onclick = () => {
      auth.signInWithPopup(provider).catch(console.error);
    };

    signOutBtn.onclick = () => {
      auth.signOut();
    };

    // 👤 Auth state check
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserUid = user.uid;
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        glForm.style.display = "flex";
        loadGLItems();
      } else {
        currentUserUid = null;
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        glForm.style.display = "none";
        itemList.innerHTML = "";
        totalGLDisplay.textContent = "0";
      }
    });

    // 📤 Add item
    glForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentUserUid) return alert("Please sign in first!");

      const item = document.getElementById("item").value.trim();
      const quantity = parseFloat(document.getElementById("quantity").value);
      const glPer100g = parseFloat(document.getElementById("glPer100g").value);
      const itemGL = (glPer100g * quantity) / 100;

      const newRef = db.ref(`glItems/${currentUserUid}`).push();
      newRef.set({ item, quantity, glPer100g, itemGL });

      glForm.reset();
    });

    // 📥 Load items
    function loadGLItems() {
      db.ref(`glItems/${currentUserUid}`).on("value", snapshot => {
        const data = snapshot.val() || {};
        itemList.innerHTML = "";
        totalGL = 0;

        Object.keys(data).forEach(id => {
          const { item, itemGL } = data[id];
          totalGL += itemGL;

          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            <span>${item} — ${itemGL.toFixed(1)} GL</span>
            <button class="btn btn-sm btn-outline-danger">Remove</button>
          `;

          li.querySelector("button").onclick = () => {
            db.ref(`glItems/${currentUserUid}/${id}`).remove();
          };

          itemList.appendChild(li);
        });

        totalGLDisplay.textContent = totalGL.toFixed(1);
      });
    }
  </script>
</body>
</html>
